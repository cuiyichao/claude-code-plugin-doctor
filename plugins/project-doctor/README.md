# Project Doctor v3.1 插件

**智能项目诊断工具 - 双模式、精准定位、进度续接、零误报**

Project Doctor v3.1 提供两种强大的诊断模式，并支持大型项目的分批诊断：

## 🎯 两种诊断模式

### 模式1️⃣: 需求驱动诊断（推荐，精准无误报）
1. **输入测试需求点**（如："用户注册需要发送邮件验证码"）
2. **精准定位相关代码**（多关键词搜索 + 依赖分析 + 完整调用链）🆕
3. **针对性验证实现**（检查是否符合需求预期，提供代码证据）🆕
4. **自动生成验证测试**（单元测试辅助验证）
5. **生成需求对照报告**（以需求为维度，清晰易懂）

### 模式2️⃣: 全链路诊断（全面，按模块扫描）🆕
1. **自动分析项目架构**（识别Controller、Service、Model等模块）
2. **逐模块健康扫描**（每个模块有专属检查清单）
3. **生成模块健康报告**（模块健康度评分 + 问题清单）

## 🎯 核心理念

**需求驱动 > 盲目扫描**

传统方式会扫描全部代码，产生大量"可能的问题"，你需要花时间甄别哪些是真问题。

v2.0 新方式：**只检查你关心的功能**，每个问题都基于需求预期，准确率大幅提升。

## ✨ 核心功能

### 1. 📋 需求收集 (Phase 0) 🆕

**诊断从这里开始！**

```bash
/project-doctor
```

插件会询问你：**想诊断哪些功能？**

你可以输入：
- ✅ "用户注册时需要发送邮件验证码"
- ✅ "订单创建后，扣减库存，发送通知"
- ✅ "测试并发下单不会超卖"
- ✅ "POST /api/orders 需要校验库存充足"

**支持多行输入，一行一个需求点。**

### 2. 🔍 快速项目分析与代码定位 (Phase 1)

不再全量扫描！插件会：
1. 快速识别项目类型（前端/后端/全栈）
2. 定位关键目录（Controller/Service/Model）
3. **基于需求关键词搜索**相关代码
4. 构建每个需求到代码的映射关系

**示例**：
```
[REQ-001] 用户注册邮件验证
📍 入口: src/controllers/AuthController.ts:registerUser()
🔗 调用链:
  → AuthController.registerUser()
  → AuthService.createUser()
  → EmailService.sendVerificationCode()
📂 涉及文件: 4 个
```

### 3. 🔬 按需求针对性审查 (Phase 2)

**核心价值所在！**

对每个需求点：
1. 读取相关代码文件
2. 理解需求预期行为
3. 根据需求类型选择审查策略：
   - 🎯 **功能需求**: 验证功能完整性、参数验证、错误处理
   - ⚡ **性能需求**: 检查N+1查询、资源管理、并发控制
   - 🔒 **安全需求**: 检查SQL注入、XSS、权限控制
   - 💾 **数据一致性**: 验证事务边界、并发安全、幂等性
   - 📊 **数据需求**: 验证数据生成逻辑、格式、完整性
   - 🎨 **UI需求**: 验证前端渲染、组件交互
   - 🔌 **接口需求**: 验证API定义、响应格式
4. 识别潜在问题（只报告真实问题，不是猜测）
5. 记录"需求 vs 实现"的对比结果

**审查清单示例**：
```yaml
✅ 邮箱格式是否验证？         → ❌ 未验证（Critical）
✅ 生成验证码？               → ✅ 已实现
✅ 发送邮件失败时是否回滚？   → ❌ 未回滚（High）
✅ 验证码是否有过期时间？     → ❌ 无过期（Medium）
```

### 4. 🧪 生成辅助验证的单元测试 (Phase 2.5) 🆕 v2.1

**自动化验证，让问题无所遁形！**

为每个需求自动生成单元测试：
1. **智能检测项目测试框架**（Jest、Mocha、JUnit、pytest等）
2. **生成针对性测试用例**：
   - ✅ 正常流程测试（Happy Path）
   - ⚠️ 问题验证测试（针对发现的 Critical/High 问题）
   - 🔄 边界条件测试（空值、并发等）
3. **一个需求一个测试文件**：`tests/requirement-validation/REQ-001.test.ts`
4. **生成测试说明文档**：如何运行、如何解读结果

**测试示例**：
```typescript
// REQ-001.test.ts - 用户注册邮件验证
describe('REQ-001: 用户注册邮件验证', () => {
  it('[Critical] 应该验证邮箱格式', async () => {
    // 针对发现的问题编写的测试
    const result = await userService.register({
      email: 'invalid-email',
      password: 'Pass123!'
    });
    expect(result.success).toBe(false);
    expect(result.error).toContain('邮箱格式无效');
  });

  it('[High] 发送邮件失败应该回滚用户创建', async () => {
    // 验证事务一致性
    emailService.sendEmail.mockRejectedValue(new Error('邮件服务不可用'));
    await expect(userService.register(...)).rejects.toThrow();
    
    // 验证用户未被创建
    const user = await userService.findByEmail('test@example.com');
    expect(user).toBeNull();
  });
});
```

**价值**：
- 🎯 **可执行的验证**：不再只有文字描述，直接运行测试看结果
- 🔍 **问题复现**：每个问题都有对应的测试用例
- ✅ **修复验证**：修复代码后，测试通过即证明问题解决
- 📊 **回归测试**：防止将来再次出现相同问题

### 5. 📝 生成需求对照报告 (Phase 3)

一键生成 `REQUIREMENT_VALIDATION_REPORT.md`，聚焦诊断结果：

#### 📊 执行摘要
- 需求实现统计（完全实现/部分实现/未实现）
- 问题统计（Critical/High/Medium/Low）
- 问题分类（需求未实现/逻辑错误/安全/性能等）

#### 📋 需求验证详情
**以需求为维度，逐个展示**：
- **需求信息**：ID、标题、描述、预期行为
- **实现情况**：代码定位、调用链、实现状态
- **已实现的功能**：表格展示
- **未实现/存在的问题**：详细描述 + 代码示例 + 修复建议
- **🧪 验证测试**：对应的测试文件和测试用例数 🆕

**v2.2 简化**：移除了评估表格、修复计划、行动计划等，只保留核心诊断结果，让报告更聚焦、更简洁。

## 🚀 使用方法

### 使用流程

```bash
# 在项目目录运行
/project-doctor
```

#### 步骤 1: 选择诊断模式

```
请选择诊断模式：

🎯 模式1: 需求驱动诊断（推荐，精准无误报）
   - 你提供测试需求/功能点
   - 优点：精准、快速、报告清晰
   - 适用：功能验证、Bug排查、测试用例验证

🔍 模式2: 全链路诊断（全面，按模块扫描）
   - 自动分析项目架构
   - 优点：全面、发现未知问题
   - 适用：项目质量评估、代码审查

请选择 → [模式1 / 模式2]
```

---

### 模式1: 需求驱动诊断流程

```bash
# 1. 选择模式1后，插件询问测试需求
请提供您想要诊断的功能点或测试需求：
> 用户注册时需要发送邮件验证码
> 订单创建后，扣减库存，发送通知

# 2. 插件确认需求解析
我已将您的需求解析为以下测试点：
[REQ-001] 用户注册邮件验证
[REQ-002] 订单创建流程
是否正确？ → 选择"✅ 正确，开始诊断"

# 3. 精准定位相关代码（多策略）
✅ 需求代码定位完成！
- 需求点: 2 个
- 入口函数: 2 个
- 相关文件: 10 个
- 完整调用链: 已构建

# 4. 针对性审查（提供代码证据）
🔬 正在按需求进行针对性审查...
[1/2] 审查 REQ-001: 用户注册邮件验证
  📂 读取代码文件 (4 个)...
  🔍 验证功能完整性、参数验证、错误处理...
  ⚠️  发现 3 个问题 (🔴 1 | 🟠 1 | 🟡 1)

[2/2] 审查 REQ-002: 订单创建流程
  📂 读取代码文件 (6 个)...
  🔍 验证数据一致性、事务管理...
  ⚠️  发现 2 个问题 (🔴 1 | 🟠 1)

# 5. 生成验证测试
🧪 正在生成辅助验证的单元测试...
✅ [REQ-001] tests/requirement-validation/REQ-001.test.ts (5 个测试用例)
✅ [REQ-002] tests/requirement-validation/REQ-002.test.ts (3 个测试用例)
✅ 测试说明文档: tests/requirement-validation/README.md

# 6. 生成需求验证报告
✅ 诊断完成！
📄 报告: ./REQUIREMENT_VALIDATION_REPORT.md
🧪 测试: ./tests/requirement-validation/ (8 个测试用例)

💡 下一步:
   1. 查看报告（每个问题都有代码证据和修复建议）
   2. 运行测试: npm test tests/requirement-validation/
   3. 修复代码
   4. 重新运行测试确保通过
```

---

### 模式2: 全链路诊断流程

```bash
# 1. 选择模式2后，自动开始分析
🔍 全链路诊断模式
开始分析项目架构...

# 2. 项目架构分析
✅ 项目架构分析完成！

📊 项目统计:
  - 项目类型: 后端服务（Node.js + Express）
  - 架构模式: MVC
  - 代码文件: 31 个
  - 代码行数: ~9,000 行

📦 模块划分:
  ├─ Controller层 (8 个文件, ~2,500 行)
  ├─ Service层 (12 个文件, ~4,500 行)
  ├─ Model/Repository层 (6 个文件, ~1,200 行)
  └─ Utils/Helper层 (5 个文件, ~800 行)

# 3. 逐模块健康扫描
🔬 正在进行全链路健康扫描...

[1/4] 扫描 Controller层 (8 个文件)...
  🔍 检查路由定义、参数验证、错误处理、安全性...
  ⚠️  发现 5 个问题 (🔴 1 | 🟠 2 | 🟡 2)
  📊 健康度: 75% ⭐⭐⭐⭐

[2/4] 扫描 Service层 (12 个文件)...
  🔍 检查业务逻辑、事务管理、数据一致性...
  ⚠️  发现 8 个问题 (🔴 2 | 🟠 3 | 🟡 3)
  📊 健康度: 65% ⭐⭐⭐

[3/4] 扫描 Model/Repository层 (6 个文件)...
  🔍 检查数据模型、查询安全、索引优化...
  ⚠️  发现 3 个问题 (🟠 2 | 🟡 1)
  📊 健康度: 80% ⭐⭐⭐⭐

[4/4] 扫描 Utils/Helper层 (5 个文件)...
  🔍 检查函数设计、错误处理、代码质量...
  ⚠️  发现 2 个问题 (🟡 2)
  📊 健康度: 90% ⭐⭐⭐⭐⭐

# 4. 生成模块健康报告
✅ 全链路扫描完成！
📄 报告: ./MODULE_HEALTH_REPORT.md
📊 项目整体健康度: 75% ⭐⭐⭐⭐
⚠️  共发现 18 个问题 (🔴 3 | 🟠 7 | 🟡 8)
```

## 🎯 适用场景

### 场景 1: 功能测试前的预检
```
需求: "测试用户登录功能"
输入: 用户登录需要验证密码强度，记录登录日志
输出: 发现密码强度未验证（Critical）
      发现登录日志缺失（High）
```

### 场景 2: Bug 修复验证
```
需求: "支付回调有时会重复处理"
输入: 支付回调需要保证幂等性
输出: 发现缺少幂等性校验（Critical）
      建议添加订单状态检查和分布式锁
```

### 场景 3: 性能优化
```
需求: "订单列表加载很慢"
输入: 订单列表查询需要高效加载
输出: 发现 N+1 查询问题（High）
      建议使用 JOIN 或 eager loading
```

### 场景 4: 安全审计
```
需求: "检查是否有 SQL 注入风险"
输入: 所有数据库查询需要防止 SQL 注入
输出: 发现 3 处使用字符串拼接构造 SQL（Critical）
      建议使用参数化查询
```

## 🎉 v3.1 新功能 (2025-11-21)

### 🔄 进度保存和续接机制 🆕

**解决大型项目的 Token 限制问题**！

当诊断大量需求（如 16 个测试用例）时，可能因为 token 限制无法一次完成。v3.1 新增：

#### 1. 实时进度保存

每完成一个需求的诊断，立即保存进度到 `.project-doctor-progress.json`：

```json
{
  "startTime": "2025-11-21T15:30:00.000Z",
  "mode": "requirement-driven",
  "totalRequirements": 16,
  "completedRequirements": [
    {
      "id": "REQ-001",
      "title": "创建视频生产任务",
      "completedAt": "2025-11-21T15:31:00.000Z",
      "issuesFound": 3
    }
  ],
  "pendingRequirements": ["REQ-009", "REQ-010", ...],
  "partialReport": "..."
}
```

#### 2. 自动检测未完成任务

下次运行 `/project-doctor` 时，插件会：

```
🔄 检测到未完成的诊断任务！

上次诊断信息：
- 开始时间: 2025-11-21 15:30
- 诊断模式: 需求驱动
- 总需求数: 16 个
- 已完成: 8 个 (50%)
- 未完成: 8 个

您希望如何处理？
✅ 继续上次诊断（从 REQ-009 开始）
🔄 重新开始诊断
📊 只查看上次报告
```

#### 3. 部分报告生成

如果因 token 限制中断，会生成：
- `REQUIREMENT_VALIDATION_REPORT_PARTIAL.md`（部分诊断结果）
- 包含已诊断需求的详细信息
- 列出未诊断的需求清单
- 提供续接指引

#### 4. 无缝续接

选择"继续上次诊断"后：
- ✅ 自动跳过已完成的需求
- ✅ 从中断点继续
- ✅ 完成后生成完整报告
- ✅ 自动合并部分结果

**使用场景**：
- 📊 大型项目（10+ 个需求点）
- 🔍 复杂代码库（调用链很深）
- ⚡ Token 受限环境

**优势**：
- 🎯 不会浪费已完成的诊断工作
- 📈 可以分多次完成大型项目诊断
- 💾 进度自动保存，不怕中断

---

## 🎉 v3.0 重大更新 (2025-11-21)

### 🔄 双模式诊断

**新增全链路诊断模式**！现在你可以选择：

1. **需求驱动模式**（v2.x 原有模式，已优化）：
   - 适合：功能验证、Bug排查、测试用例验证
   - 优点：精准、快速、无误报
   
2. **全链路模式**（全新）：
   - 适合：项目质量评估、代码审查、重构前评估
   - 自动识别核心业务功能模块
   - 按模块（Controller、Service、Model、Utils）进行健康扫描
   - 生成模块健康度评分报告

### 🎯 更精准的代码定位（需求驱动模式优化）

原来的单关键词搜索 → 现在的多策略精准定位：

**策略1: 多关键词组合搜索**
- 业务关键词（中英文）
- API/路径关键词
- 实体/模型关键词
- 取交集提高精度

**策略2: 依赖关系分析**
- 分析 import/require 语句
- 识别模块依赖关系
- 解析实际文件路径

**策略3: 完整调用链追踪**
- 从入口点逐层追踪
- 递归分析函数调用
- 构建完整调用路径

**示例**：
```
Before (v2.x): 
  - 搜索 "register" → 找到 10 个文件 → 需要手动判断

After (v3.0):
  - 多关键词 "register" + "email" → 精确到 4 个文件
  - 分析依赖 → 定位到 AuthService、EmailService
  - 追踪调用链 → 完整路径
    AuthController.register()
    → AuthService.createUser()
      → UserRepository.save()
      → EmailService.sendVerificationCode()
        → EmailProvider.send()
```

### 📝 强化审查清单（提供代码证据）

原来的简单 checklist → 现在的详细问题报告：

**每个问题包含**：
1. **代码证据**：实际的代码片段
2. **问题原因**：为什么这是问题
3. **影响范围**：会导致什么后果
4. **修复建议**：具体的修复代码

**示例**：
```markdown
## 🔴 [Critical] 缺少邮箱格式验证

**位置**: src/controllers/AuthController.ts:45

**代码证据**:
```typescript
const { email, password } = req.body;
const user = await this.authService.createUser(email, password);
\```

**为什么是问题**:
1. 缺少输入验证
2. 允许非法邮箱格式
3. 导致后续邮件发送失败

**影响范围**:
- 数据质量：数据库存在无效邮箱
- 用户体验：用户永远收不到验证邮件
- 运维成本：EmailService 频繁失败

**修复建议**: [具体代码]
\```
```

### 📊 简化报告格式

移除了复杂的评估表格、行动计划等，只保留核心内容：
- ✅ 需求/模块信息
- ✅ 实现情况/健康度
- ✅ 问题列表（含代码证据）
- ✅ 修复建议

让报告更聚焦、更易读。

---

## 🎉 v2.2 新功能 (2025-11-21) - 已整合到 v3.0

### 🧪 自动生成验证测试

诊断报告告诉你"有什么问题"，但如何验证修复效果？

**v2.1 新增**：自动为每个需求生成单元测试！

**生成的测试包括**：
- ✅ **正常流程测试**：验证需求的主要功能
- ⚠️ **问题验证测试**：针对发现的每个 Critical/High 问题编写测试
- 🔄 **边界条件测试**：空值、并发、最大值等

**支持的测试框架**：
- JavaScript/TypeScript: Jest、Mocha、Vitest
- Java: JUnit 4/5
- Python: pytest、unittest
- Go: testing 包

**工作流程**：
```bash
1. 运行诊断 → 发现问题 → 生成测试
2. 运行测试 → 看到哪些失败（预期的）
3. 修复代码
4. 重新运行测试 → 全部通过 ✅
```

**示例输出**：
```
tests/requirement-validation/
├── REQ-001.test.ts          # 用户注册邮件验证（5个用例）
├── REQ-002.test.ts          # 订单创建流程（3个用例）
└── README.md                 # 测试说明文档
```

### 📋 简化报告格式

**移除了**：
- ❌ 评估表格（功能完整性、数据一致性等评分）
- ❌ 修复计划表格（预计时间、优先级排序）
- ❌ 行动计划章节
- ❌ 总体评估章节

**只保留核心内容**：
- ✅ 需求信息
- ✅ 实现情况
- ✅ 问题列表
- ✅ 修复建议
- ✅ 验证测试引用

**原因**：用户反馈报告太长，只需要知道"有什么问题、如何修复"即可。

### 📄 支持结构化测试用例输入

除了自由文本输入，现在支持从文件读取结构化测试用例：

```
测试用例ID: TC_LOGIN_001
用例标题: 用户登录功能
用例类型: FUNCTIONAL
优先级: P0
测试步骤:
1. 输入正确的用户名和密码
2. 点击登录按钮
3. 验证跳转到首页
预期结果: 成功登录并显示用户信息
```

插件会自动解析并支持选择性诊断（只诊断P0、或手动选择等）。

---

## ✨ v2.0 核心优势

### 🎯 精准：大幅减少误报

**v1.0 传统方式**：
- 扫描全部代码 → 发现 50 个"可能的问题"
- 你需要花 2 小时甄别 → 实际只有 5 个真问题
- ❌ 误报率高达 90%

**v2.0 需求驱动**：
- 只扫描你关心的 2 个功能 → 发现 5 个问题
- 每个问题都基于需求预期 → 全部是真问题
- ✅ 准确率接近 100%

### 🚀 高效：节省审查时间

| 对比项 | v1.0 盲目扫描 | v2.0 需求驱动 |
|--------|-------------|-------------|
| 扫描范围 | 全部代码 | 需求相关代码 |
| 扫描文件 | ~100 个文件 | ~10 个文件 |
| 发现问题 | 50 个（含误报） | 5 个（全部真实） |
| 甄别时间 | 2 小时 | 0 小时（无需甄别） |
| 报告可读性 | 难以理解 | 以需求为维度，清晰 |

### 💡 易懂：需求维度的报告

**v1.0 报告**：
```
OrderController.ts:45 - 参数未验证
OrderService.ts:78 - 缺少事务
InventoryService.ts:120 - 并发问题
...（50 个问题混在一起）
```

**v2.0 报告**：
```
[REQ-002] 订单创建流程
实现状态: ❌ 实现错误 (45/100 分)

发现的问题:
🔴 [Critical] 事务一致性缺失
   → 库存扣减成功但订单创建失败，库存数据错误
   → 建议：使用数据库事务
   → 预计修复：4 小时

🔴 [Critical] 库存并发控制缺失
   → 多个请求同时扣减库存，可能超卖
   → 建议：使用数据库行锁
   → 预计修复：3 小时
```

### 🎨 智能：4种审查策略

不同类型的需求，使用不同的审查策略：
- 🎯 **功能需求**: 检查功能完整性、参数验证、错误处理
- ⚡ **性能需求**: 检查 N+1 查询、资源管理、并发控制
- 🔒 **安全需求**: 检查 SQL 注入、XSS、权限控制
- 💾 **数据一致性**: 检查事务边界、并发安全、幂等性

---

## 📋 示例报告片段

### 1. 模块健康度总览

```markdown
## 🔍 2. 按模块诊断结果

### 2.1 Controller 层 (`src/controllers/`)

#### 📊 模块健康度: 85% ⭐⭐⭐⭐

**扫描文件**: 8 个  
**发现问题**: 5 个 (🔴 1 | 🟠 2 | 🟡 2)
```

### 2. 详细问题分析

```markdown
##### ⚠️ **OrderController.ts**

**🔴 [Critical] 参数校验缺失**
- **位置**: `OrderController.ts:45-52`
- **问题描述**: 
  ```typescript
  // 当前代码
  async createOrder(req: Request) {
    const { userId, items } = req.body;
    return await orderService.create(userId, items);
  }
  ```
  未验证 `userId` 是否存在，`items` 是否为空数组。
  
- **影响**: 可能导致创建无效订单，影响数据一致性
- **建议修复**:
  ```typescript
  async createOrder(req: Request) {
    const { userId, items } = req.body;
    
    // 添加参数验证
    if (!userId || !items || items.length === 0) {
      throw new ValidationError('Invalid request parameters');
    }
    
    return await orderService.create(userId, items);
  }
  ```
```

### 3. 全链路分析

```markdown
### 3.1 功能：创建订单 (POST /api/orders)

#### 调用链路

```
客户端请求
    ↓
OrderController.createOrder() [src/controllers/OrderController.ts:45]
    ↓
OrderService.create() [src/services/OrderService.ts:125]
    ├─→ InventoryService.deduct()
    ├─→ OrderRepository.create()
    └─→ NotificationService.send()
```

#### 风险评估

| 风险类型 | 严重程度 | 发生概率 | 影响范围 |
|---------|---------|---------|---------|
| 数据不一致 | 🔴 高 | 中 | 订单、库存 |
| 超卖问题 | 🔴 高 | 低 | 库存 |
| 无效订单 | 🟠 中 | 中 | 订单 |
```

### 4. 行动计划

```markdown
## 🛠️ 5. 修复建议与行动计划

### 5.1 立即修复（1-2天内）

**优先级 P0 - Critical 问题**

1. **修复 OrderService 事务一致性问题**
   - 文件: `src/services/OrderService.ts`
   - 预计耗时: 4 小时
   - 需要: 添加数据库事务支持
   - 测试: 模拟失败场景验证回滚
```
