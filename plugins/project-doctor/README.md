# Project Doctor v2.2 插件

**需求驱动的项目诊断工具 - 精准、高效、无误报**

Project Doctor v2.1 彻底革新了代码审查方式。不再盲目扫描全部代码产生大量误报，而是：
1. **让你先输入测试需求点**（如："用户注册需要发送邮件验证码"）
2. **智能定位相关代码**（基于关键词搜索）
3. **针对性验证实现**（检查是否符合需求预期）
4. **生成验证测试用例**（自动生成单元测试辅助验证） 🆕
5. **生成需求对照报告**（以需求为维度，清晰易懂）

## 🎯 核心理念

**需求驱动 > 盲目扫描**

传统方式会扫描全部代码，产生大量"可能的问题"，你需要花时间甄别哪些是真问题。

v2.0 新方式：**只检查你关心的功能**，每个问题都基于需求预期，准确率大幅提升。

## ✨ 核心功能

### 1. 📋 需求收集 (Phase 0) 🆕

**诊断从这里开始！**

```bash
/project-doctor
```

插件会询问你：**想诊断哪些功能？**

你可以输入：
- ✅ "用户注册时需要发送邮件验证码"
- ✅ "订单创建后，扣减库存，发送通知"
- ✅ "测试并发下单不会超卖"
- ✅ "POST /api/orders 需要校验库存充足"

**支持多行输入，一行一个需求点。**

### 2. 🔍 快速项目分析与代码定位 (Phase 1)

不再全量扫描！插件会：
1. 快速识别项目类型（前端/后端/全栈）
2. 定位关键目录（Controller/Service/Model）
3. **基于需求关键词搜索**相关代码
4. 构建每个需求到代码的映射关系

**示例**：
```
[REQ-001] 用户注册邮件验证
📍 入口: src/controllers/AuthController.ts:registerUser()
🔗 调用链:
  → AuthController.registerUser()
  → AuthService.createUser()
  → EmailService.sendVerificationCode()
📂 涉及文件: 4 个
```

### 3. 🔬 按需求针对性审查 (Phase 2)

**核心价值所在！**

对每个需求点：
1. 读取相关代码文件
2. 理解需求预期行为
3. 根据需求类型选择审查策略：
   - 🎯 **功能需求**: 验证功能完整性、参数验证、错误处理
   - ⚡ **性能需求**: 检查N+1查询、资源管理、并发控制
   - 🔒 **安全需求**: 检查SQL注入、XSS、权限控制
   - 💾 **数据一致性**: 验证事务边界、并发安全、幂等性
   - 📊 **数据需求**: 验证数据生成逻辑、格式、完整性
   - 🎨 **UI需求**: 验证前端渲染、组件交互
   - 🔌 **接口需求**: 验证API定义、响应格式
4. 识别潜在问题（只报告真实问题，不是猜测）
5. 记录"需求 vs 实现"的对比结果

**审查清单示例**：
```yaml
✅ 邮箱格式是否验证？         → ❌ 未验证（Critical）
✅ 生成验证码？               → ✅ 已实现
✅ 发送邮件失败时是否回滚？   → ❌ 未回滚（High）
✅ 验证码是否有过期时间？     → ❌ 无过期（Medium）
```

### 4. 🧪 生成辅助验证的单元测试 (Phase 2.5) 🆕 v2.1

**自动化验证，让问题无所遁形！**

为每个需求自动生成单元测试：
1. **智能检测项目测试框架**（Jest、Mocha、JUnit、pytest等）
2. **生成针对性测试用例**：
   - ✅ 正常流程测试（Happy Path）
   - ⚠️ 问题验证测试（针对发现的 Critical/High 问题）
   - 🔄 边界条件测试（空值、并发等）
3. **一个需求一个测试文件**：`tests/requirement-validation/REQ-001.test.ts`
4. **生成测试说明文档**：如何运行、如何解读结果

**测试示例**：
```typescript
// REQ-001.test.ts - 用户注册邮件验证
describe('REQ-001: 用户注册邮件验证', () => {
  it('[Critical] 应该验证邮箱格式', async () => {
    // 针对发现的问题编写的测试
    const result = await userService.register({
      email: 'invalid-email',
      password: 'Pass123!'
    });
    expect(result.success).toBe(false);
    expect(result.error).toContain('邮箱格式无效');
  });

  it('[High] 发送邮件失败应该回滚用户创建', async () => {
    // 验证事务一致性
    emailService.sendEmail.mockRejectedValue(new Error('邮件服务不可用'));
    await expect(userService.register(...)).rejects.toThrow();
    
    // 验证用户未被创建
    const user = await userService.findByEmail('test@example.com');
    expect(user).toBeNull();
  });
});
```

**价值**：
- 🎯 **可执行的验证**：不再只有文字描述，直接运行测试看结果
- 🔍 **问题复现**：每个问题都有对应的测试用例
- ✅ **修复验证**：修复代码后，测试通过即证明问题解决
- 📊 **回归测试**：防止将来再次出现相同问题

### 5. 📝 生成需求对照报告 (Phase 3)

一键生成 `REQUIREMENT_VALIDATION_REPORT.md`，聚焦诊断结果：

#### 📊 执行摘要
- 需求实现统计（完全实现/部分实现/未实现）
- 问题统计（Critical/High/Medium/Low）
- 问题分类（需求未实现/逻辑错误/安全/性能等）

#### 📋 需求验证详情
**以需求为维度，逐个展示**：
- **需求信息**：ID、标题、描述、预期行为
- **实现情况**：代码定位、调用链、实现状态
- **已实现的功能**：表格展示
- **未实现/存在的问题**：详细描述 + 代码示例 + 修复建议
- **🧪 验证测试**：对应的测试文件和测试用例数 🆕

**v2.2 简化**：移除了评估表格、修复计划、行动计划等，只保留核心诊断结果，让报告更聚焦、更简洁。

## 🚀 使用方法

### 完整流程示例

```bash
# 1. 在项目目录运行
/project-doctor

# 2. 插件询问你的测试需求
请提供您想要诊断的功能点或测试需求：
> 用户注册时需要发送邮件验证码
> 订单创建后，扣减库存，发送通知

# 3. 插件确认需求解析
我已将您的需求解析为以下测试点：
[REQ-001] 用户注册邮件验证
[REQ-002] 订单创建流程
是否正确？ → 选择"✅ 正确，开始诊断"

# 4. 插件快速定位相关代码
✅ 需求代码定位完成！
- 需求点: 2 个
- 入口函数: 2 个
- 相关文件: 10 个

# 5. 针对性审查
🔬 正在按需求进行针对性审查...
[1/2] 审查 REQ-001: 用户注册邮件验证
      ⚠️ 发现 3 个问题 (🔴 1 | 🟠 1 | 🟡 1)
[2/2] 审查 REQ-002: 订单创建流程
      ⚠️ 发现 2 个问题 (🔴 1 | 🟠 1)

# 6. 生成验证测试 🆕
🧪 正在生成辅助验证的单元测试...
✅ [REQ-001] tests/requirement-validation/REQ-001.test.ts (5 个测试用例)
✅ [REQ-002] tests/requirement-validation/REQ-002.test.ts (3 个测试用例)
✅ 测试说明文档: tests/requirement-validation/README.md

# 7. 生成报告
✅ 诊断完成！
📄 报告位置: ./REQUIREMENT_VALIDATION_REPORT.md
🧪 验证测试: ./tests/requirement-validation/ (8 个测试用例)

💡 下一步:
   1. 查看报告了解问题详情
   2. 运行测试验证问题: npm test tests/requirement-validation/
   3. 修复代码
   4. 重新运行测试确保通过
```

## 🎯 适用场景

### 场景 1: 功能测试前的预检
```
需求: "测试用户登录功能"
输入: 用户登录需要验证密码强度，记录登录日志
输出: 发现密码强度未验证（Critical）
      发现登录日志缺失（High）
```

### 场景 2: Bug 修复验证
```
需求: "支付回调有时会重复处理"
输入: 支付回调需要保证幂等性
输出: 发现缺少幂等性校验（Critical）
      建议添加订单状态检查和分布式锁
```

### 场景 3: 性能优化
```
需求: "订单列表加载很慢"
输入: 订单列表查询需要高效加载
输出: 发现 N+1 查询问题（High）
      建议使用 JOIN 或 eager loading
```

### 场景 4: 安全审计
```
需求: "检查是否有 SQL 注入风险"
输入: 所有数据库查询需要防止 SQL 注入
输出: 发现 3 处使用字符串拼接构造 SQL（Critical）
      建议使用参数化查询
```

## 🎉 v2.2 新功能 (2025-11-21)

### 🧪 自动生成验证测试

诊断报告告诉你"有什么问题"，但如何验证修复效果？

**v2.1 新增**：自动为每个需求生成单元测试！

**生成的测试包括**：
- ✅ **正常流程测试**：验证需求的主要功能
- ⚠️ **问题验证测试**：针对发现的每个 Critical/High 问题编写测试
- 🔄 **边界条件测试**：空值、并发、最大值等

**支持的测试框架**：
- JavaScript/TypeScript: Jest、Mocha、Vitest
- Java: JUnit 4/5
- Python: pytest、unittest
- Go: testing 包

**工作流程**：
```bash
1. 运行诊断 → 发现问题 → 生成测试
2. 运行测试 → 看到哪些失败（预期的）
3. 修复代码
4. 重新运行测试 → 全部通过 ✅
```

**示例输出**：
```
tests/requirement-validation/
├── REQ-001.test.ts          # 用户注册邮件验证（5个用例）
├── REQ-002.test.ts          # 订单创建流程（3个用例）
└── README.md                 # 测试说明文档
```

### 📋 简化报告格式

**移除了**：
- ❌ 评估表格（功能完整性、数据一致性等评分）
- ❌ 修复计划表格（预计时间、优先级排序）
- ❌ 行动计划章节
- ❌ 总体评估章节

**只保留核心内容**：
- ✅ 需求信息
- ✅ 实现情况
- ✅ 问题列表
- ✅ 修复建议
- ✅ 验证测试引用

**原因**：用户反馈报告太长，只需要知道"有什么问题、如何修复"即可。

### 📄 支持结构化测试用例输入

除了自由文本输入，现在支持从文件读取结构化测试用例：

```
测试用例ID: TC_LOGIN_001
用例标题: 用户登录功能
用例类型: FUNCTIONAL
优先级: P0
测试步骤:
1. 输入正确的用户名和密码
2. 点击登录按钮
3. 验证跳转到首页
预期结果: 成功登录并显示用户信息
```

插件会自动解析并支持选择性诊断（只诊断P0、或手动选择等）。

---

## ✨ v2.0 核心优势

### 🎯 精准：大幅减少误报

**v1.0 传统方式**：
- 扫描全部代码 → 发现 50 个"可能的问题"
- 你需要花 2 小时甄别 → 实际只有 5 个真问题
- ❌ 误报率高达 90%

**v2.0 需求驱动**：
- 只扫描你关心的 2 个功能 → 发现 5 个问题
- 每个问题都基于需求预期 → 全部是真问题
- ✅ 准确率接近 100%

### 🚀 高效：节省审查时间

| 对比项 | v1.0 盲目扫描 | v2.0 需求驱动 |
|--------|-------------|-------------|
| 扫描范围 | 全部代码 | 需求相关代码 |
| 扫描文件 | ~100 个文件 | ~10 个文件 |
| 发现问题 | 50 个（含误报） | 5 个（全部真实） |
| 甄别时间 | 2 小时 | 0 小时（无需甄别） |
| 报告可读性 | 难以理解 | 以需求为维度，清晰 |

### 💡 易懂：需求维度的报告

**v1.0 报告**：
```
OrderController.ts:45 - 参数未验证
OrderService.ts:78 - 缺少事务
InventoryService.ts:120 - 并发问题
...（50 个问题混在一起）
```

**v2.0 报告**：
```
[REQ-002] 订单创建流程
实现状态: ❌ 实现错误 (45/100 分)

发现的问题:
🔴 [Critical] 事务一致性缺失
   → 库存扣减成功但订单创建失败，库存数据错误
   → 建议：使用数据库事务
   → 预计修复：4 小时

🔴 [Critical] 库存并发控制缺失
   → 多个请求同时扣减库存，可能超卖
   → 建议：使用数据库行锁
   → 预计修复：3 小时
```

### 🎨 智能：4种审查策略

不同类型的需求，使用不同的审查策略：
- 🎯 **功能需求**: 检查功能完整性、参数验证、错误处理
- ⚡ **性能需求**: 检查 N+1 查询、资源管理、并发控制
- 🔒 **安全需求**: 检查 SQL 注入、XSS、权限控制
- 💾 **数据一致性**: 检查事务边界、并发安全、幂等性

---

## 📋 示例报告片段

### 1. 模块健康度总览

```markdown
## 🔍 2. 按模块诊断结果

### 2.1 Controller 层 (`src/controllers/`)

#### 📊 模块健康度: 85% ⭐⭐⭐⭐

**扫描文件**: 8 个  
**发现问题**: 5 个 (🔴 1 | 🟠 2 | 🟡 2)
```

### 2. 详细问题分析

```markdown
##### ⚠️ **OrderController.ts**

**🔴 [Critical] 参数校验缺失**
- **位置**: `OrderController.ts:45-52`
- **问题描述**: 
  ```typescript
  // 当前代码
  async createOrder(req: Request) {
    const { userId, items } = req.body;
    return await orderService.create(userId, items);
  }
  ```
  未验证 `userId` 是否存在，`items` 是否为空数组。
  
- **影响**: 可能导致创建无效订单，影响数据一致性
- **建议修复**:
  ```typescript
  async createOrder(req: Request) {
    const { userId, items } = req.body;
    
    // 添加参数验证
    if (!userId || !items || items.length === 0) {
      throw new ValidationError('Invalid request parameters');
    }
    
    return await orderService.create(userId, items);
  }
  ```
```

### 3. 全链路分析

```markdown
### 3.1 功能：创建订单 (POST /api/orders)

#### 调用链路

```
客户端请求
    ↓
OrderController.createOrder() [src/controllers/OrderController.ts:45]
    ↓
OrderService.create() [src/services/OrderService.ts:125]
    ├─→ InventoryService.deduct()
    ├─→ OrderRepository.create()
    └─→ NotificationService.send()
```

#### 风险评估

| 风险类型 | 严重程度 | 发生概率 | 影响范围 |
|---------|---------|---------|---------|
| 数据不一致 | 🔴 高 | 中 | 订单、库存 |
| 超卖问题 | 🔴 高 | 低 | 库存 |
| 无效订单 | 🟠 中 | 中 | 订单 |
```

### 4. 行动计划

```markdown
## 🛠️ 5. 修复建议与行动计划

### 5.1 立即修复（1-2天内）

**优先级 P0 - Critical 问题**

1. **修复 OrderService 事务一致性问题**
   - 文件: `src/services/OrderService.ts`
   - 预计耗时: 4 小时
   - 需要: 添加数据库事务支持
   - 测试: 模拟失败场景验证回滚
```
