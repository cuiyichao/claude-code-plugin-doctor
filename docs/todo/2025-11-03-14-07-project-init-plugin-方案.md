# Project-Init Plugin 架构方案设计

## 1. 项目概述

### 1.1 需求背景
用户需要创建一个类似 code-review plugin 的项目初始化插件，用于快速为新项目生成标准化的 CLAUDE.md 开发规范文件。

### 1.2 核心目标
- 基于 CLAUDE_TEMPLATE.md 模板快速初始化项目规范
- 提供交互式问答引导用户填写项目信息
- 自动生成符合项目特点的 CLAUDE.md 文件
- 参考 code-review plugin 架构，确保代码结构清晰

## 2. 需求分析

### 2.1 功能需求
1. **模板读取**：读取 CLAUDE_TEMPLATE.md 模板内容
2. **交互式配置**：通过 AskUserQuestion 工具收集项目信息
3. **文件生成**：根据用户输入生成定制化的 CLAUDE.md 文件
4. **位置检测**：自动检测是否已存在 CLAUDE.md，避免覆盖

### 2.2 用户交互流程
```
用户执行 /project-init
  ↓
检查是否已存在 CLAUDE.md
  ↓
读取 CLAUDE_TEMPLATE.md
  ↓
询问项目基础信息（项目名称、技术栈、架构等）
  ↓
询问测试规范配置
  ↓
询问开发规则偏好
  ↓
生成 CLAUDE.md 文件
  ↓
确认生成成功
```

### 2.3 数据流转
```
CLAUDE_TEMPLATE.md (模板)
    ↓
Read 工具读取
    ↓
提取需要填充的占位符 [占位符]
    ↓
AskUserQuestion 收集用户输入
    ↓
字符串替换 [占位符] → 实际内容
    ↓
Write 工具写入 CLAUDE.md
```

## 3. 架构设计

### 3.1 目录结构
```
project-init/
├── .claude-plugin/
│   └── plugin.json          # Plugin 配置元数据
├── commands/
│   └── project-init.md      # 命令实现逻辑
└── README.md                # Plugin 使用文档
```

### 3.2 核心文件设计

#### 3.2.1 plugin.json
```json
{
  "name": "project-init",
  "description": "快速初始化项目 CLAUDE.md 规范文件，基于 CLAUDE_TEMPLATE.md 模板生成定制化开发规范",
  "version": "1.0.0",
  "author": {
    "name": "Wang Xuecheng",
    "email": "your-email@example.com"
  }
}
```

**字段说明**：
- `name`: plugin 唯一标识符，用于命令调用
- `description`: 功能描述，显示在 plugin 列表中
- `version`: 遵循语义化版本控制
- `author`: 作者信息，便于维护和联系

#### 3.2.2 commands/project-init.md

**Frontmatter 配置**：
```yaml
---
allowed-tools: Read, Write, AskUserQuestion, Bash(ls:*), Bash(test:*)
description: 基于 CLAUDE_TEMPLATE.md 快速初始化项目规范文件
---
```

**命令执行流程**：
1. **前置检查**
   - 检查当前目录是否已存在 CLAUDE.md
   - 如果存在，询问是否覆盖
   - 检查 CLAUDE_TEMPLATE.md 是否存在

2. **模板解析**
   - 读取 CLAUDE_TEMPLATE.md 内容
   - 识别所有需要填充的占位符
   - 按优先级排序（核心信息 → 可选配置）

3. **信息收集**
   - **项目基础信息**：
     - 项目名称
     - 项目描述
     - 技术栈（框架、数据库、语言）
     - 代码风格（命名规范）

   - **架构信息**：
     - 项目架构模式
     - 关键模块说明

   - **测试规范**：
     - 是否启用测试覆盖率要求
     - Mock 数据管理方式

   - **开发规则**：
     - 命名规范偏好
     - 错误处理机制
     - 版本控制策略

4. **文件生成**
   - 替换模板中的占位符
   - 添加生成时间戳
   - 写入 CLAUDE.md 文件
   - 确认生成成功

### 3.3 技术实现细节

#### 占位符识别策略
```javascript
// 伪代码示例
const placeholders = {
  '[项目名称]': 'project_name',
  '[项目一句话描述]': 'project_description',
  '[框架名称和版本]': 'framework',
  '[数据库/缓存技术]': 'database',
  '[语言和版本]': 'language',
  '[命名规范]': 'naming_convention',
  // ... 其他占位符
}

// 遍历模板内容，提取所有 [xxx] 格式的占位符
function extractPlaceholders(template) {
  const regex = /\[([^\]]+)\]/g;
  return [...template.matchAll(regex)].map(m => m[1]);
}
```

#### 交互式问答设计
```markdown
使用 AskUserQuestion 工具分批收集信息：

第一批：核心项目信息
- 项目名称（必填）
- 项目描述（必填）

第二批：技术栈信息
- 开发语言（Python/Go/Java/TypeScript/其他）
- 主要框架
- 数据存储技术

第三批：架构选择
- 架构模式（MVC/微服务/Serverless/其他）

第四批：规范配置
- 是否启用严格测试覆盖率要求
- 是否使用 Git 提交审批流程
```

## 4. KISS 原则分析

### 4.1 这是真问题还是臆想的？
✅ **真问题**
- 每个新项目都需要建立开发规范
- 手动填写 CLAUDE.md 容易遗漏关键配置
- 标准化模板能提高团队协作效率
- 参考 code-review plugin 说明 Claude Code 生态支持此类工具

### 4.2 有更简单的方法吗？
当前方案已是最简方案：
- ✅ 复用现有 CLAUDE_TEMPLATE.md，无需重新设计模板
- ✅ 使用 Claude Code 内置工具（Read/Write/AskUserQuestion）
- ✅ 不引入外部依赖
- ❌ 不使用复杂的配置系统
- ❌ 不需要数据库存储

**替代方案对比**：
| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| 手动复制模板 | 最简单 | 容易遗漏，无引导 | 不满足需求 |
| Web UI 配置器 | 体验好 | 过度设计，需维护 | 过于复杂 |
| 当前方案 | 平衡简洁与功能 | - | ✅ 最优 |

### 4.3 会破坏什么吗？
**向后兼容性分析**：
- ✅ 不修改现有文件（除非用户确认覆盖）
- ✅ 不依赖特定目录结构
- ✅ 可在任何项目目录下安全执行
- ⚠️ 需检测现有 CLAUDE.md 避免意外覆盖

**风险缓解**：
- 执行前检查 CLAUDE.md 是否存在
- 如果存在，提供三个选项：
  1. 备份后覆盖（推荐）
  2. 直接覆盖
  3. 取消操作

### 4.4 真的需要这个功能吗？
✅ **确认需要**
- 用户明确提出需求："实现和 /init 一样的功能"
- 有现成模板（CLAUDE_TEMPLATE.md）需要批量应用
- 能显著提升项目初始化效率

## 5. 性能影响评估

### 5.1 资源消耗
- **文件 I/O**：
  - 读取 1 个模板文件（~8KB）
  - 写入 1 个配置文件（~10KB）
  - 影响：可忽略

- **用户交互**：
  - 4-6 轮问答交互
  - 每轮等待用户输入
  - 影响：取决于用户响应速度

- **Token 消耗**：
  - 模板内容 ~2000 tokens
  - 命令逻辑 ~500 tokens
  - 总计：< 3000 tokens/次执行
  - 影响：低

### 5.2 执行时间
- 文件读写：< 100ms
- 用户交互：30秒 - 3分钟（用户决定）
- 总时间：主要取决于用户填写速度

### 5.3 性能优化策略
- ✅ 使用缓存避免重复读取模板
- ✅ 批量收集信息，减少交互轮次
- ❌ 不需要异步处理（操作简单）
- ❌ 不需要并行处理（依赖用户输入）

## 6. 风险分析与缓解措施

### 6.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| CLAUDE_TEMPLATE.md 不存在 | 中 | 高 | 执行前检查，提供清晰错误提示 |
| 用户输入非法字符 | 低 | 中 | 输入验证，转义特殊字符 |
| 文件写入权限不足 | 低 | 高 | 捕获异常，提示用户检查权限 |
| 意外覆盖重要文件 | 中 | 高 | 覆盖前二次确认，提供备份选项 |

### 6.2 用户体验风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 问题过多导致疲劳 | 高 | 中 | 提供默认值，允许快速跳过 |
| 不理解技术术语 | 中 | 中 | 每个选项提供详细说明和示例 |
| 填写错误想重新开始 | 中 | 低 | 提供"取消重来"选项 |

### 6.3 维护风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 模板格式变更 | 中 | 中 | 使用灵活的占位符识别机制 |
| Claude Code API 变更 | 低 | 高 | 遵循官方文档，关注版本更新 |

## 7. 实施步骤

### 7.1 开发阶段
1. ✅ 创建目录结构（.claude-plugin, commands）
2. ✅ 编写 plugin.json 配置文件
3. ✅ 实现 commands/project-init.md 命令逻辑
4. ✅ 编写 README.md 使用文档

### 7.2 测试阶段
1. ⏸ 测试模板读取功能
2. ⏸ 测试交互式问答流程
3. ⏸ 测试文件生成正确性
4. ⏸ 测试边界情况（文件已存在、权限不足等）
5. ⏸ 测试不同项目类型的适配性

### 7.3 文档阶段
1. ⏸ 编写安装说明
2. ⏸ 提供使用示例
3. ⏸ 记录常见问题（FAQ）
4. ⏸ 生成测试报告（根据用户的测试规范要求）

## 8. 验收标准

### 8.1 功能验收
- [ ] 成功读取 CLAUDE_TEMPLATE.md 模板
- [ ] 所有必填字段都有交互式收集
- [ ] 生成的 CLAUDE.md 格式正确
- [ ] 覆盖场景有二次确认
- [ ] 错误情况有清晰提示

### 8.2 代码质量验收
- [ ] 遵循 Claude Code plugin 规范
- [ ] 命令文档结构清晰
- [ ] 无硬编码配置
- [ ] 异常处理完善

### 8.3 用户体验验收
- [ ] 问答流程顺畅，逻辑清晰
- [ ] 每个选项都有详细说明
- [ ] 操作可撤销或重来
- [ ] 执行结果有明确反馈

## 9. 附录

### 9.1 参考架构
- Code-review plugin: https://github.com/anthropics/claude-code/tree/main/plugins/code-review
- CLAUDE_TEMPLATE.md: 项目根目录

### 9.2 技术栈
- Claude Code CLI
- Markdown (命令定义)
- JSON (配置文件)

### 9.3 关键工具
- `Read`: 读取模板文件
- `Write`: 生成 CLAUDE.md
- `AskUserQuestion`: 交互式收集用户输入
- `Bash`: 文件检测和备份操作

---

**方案制定时间**: 2025-11-03 14:07
**方案制定人**: Claude Code Assistant
**方案版本**: v1.0
**待审批**: 等待用户确认后开始实施
